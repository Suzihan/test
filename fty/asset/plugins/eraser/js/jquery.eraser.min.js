(function(b){var a={init:function(c){return this.each(function(){var f=b(this),e=f.data("eraser");if(!e){var d=function(){var k=b("<canvas/>"),i=k.get(0),z=i.getContext("2d"),B=window.devicePixelRatio||1,o=z.webkitBackingStorePixelRatio||z.mozBackingStorePixelRatio||z.msBackingStorePixelRatio||z.oBackingStorePixelRatio||z.backingStorePixelRatio||1,t=B/o,x=f.width(),A=f.height(),y=x*t,q=A*t,j=f.offset(),m=(c&&c.enabled===false)?false:true,p=((c&&c.size)?c.size:40)*t,h=(c&&c.completeRatio)?c.completeRatio:0.7,g=(c&&c.completeFunction)?c.completeFunction:null,s=(c&&c.progressFunction)?c.progressFunction:null,r=f.css("z-index")=="auto"?1:f.css("z-index"),w=[],C=Math.floor(y/p),u=C*Math.floor(q/p),v=u,l=f[0];f.after(k);i.id=l.id;i.className=l.className;i.width=y;i.height=q;i.style.width=x.toString()+"px";i.style.height=A.toString()+"px";z.drawImage(l,0,0,y,q);f.remove();z.globalCompositeOperation="destination-out";z.strokeStyle="rgba(255,0,0,255)";z.lineWidth=p;z.lineCap="round";k.bind("mousedown.eraser",a.mouseDown);k.bind("touchstart.eraser",a.touchStart);k.bind("touchmove.eraser",a.touchMove);k.bind("touchend.eraser",a.touchEnd);while(v--){w.push(1)}e={posX:j.left,posY:j.top,touchDown:false,touchID:-999,touchX:0,touchY:0,ptouchX:0,ptouchY:0,canvas:k,ctx:z,w:y,h:q,scaleRatio:t,source:l,size:p,parts:w,colParts:C,numParts:u,ratio:0,enabled:m,complete:false,completeRatio:h,completeFunction:g,progressFunction:s,zIndex:r};k.data("eraser",e);b(window).resize(function(){var n=k.offset();e.posX=n.left;e.posY=n.top})};if(this.complete&&this.naturalWidth>0){d()}else{f.load(d)}}})},touchStart:function(f){var h=b(this),g=h.data("eraser");if(!g.touchDown){var e=f.originalEvent.changedTouches[0],d=e.pageX-g.posX,c=e.pageY-g.posY;d*=g.scaleRatio;c*=g.scaleRatio;if(g.enabled){a.evaluatePoint(g,d,c)}g.touchDown=true;g.touchID=e.identifier;g.touchX=d;g.touchY=c;f.preventDefault()}},touchMove:function(f){var h=b(this),g=h.data("eraser");if(g.touchDown){var e=f.originalEvent.changedTouches,i=e.length;while(i--){if(e[i].identifier==g.touchID){var d=e[i].pageX-g.posX,c=e[i].pageY-g.posY;d*=g.scaleRatio;c*=g.scaleRatio;if(g.enabled){a.evaluatePoint(g,d,c);g.ctx.beginPath();g.ctx.moveTo(g.touchX,g.touchY);g.ctx.lineTo(d,c);g.ctx.stroke();h.css({"z-index":h.css("z-index")==g.zIndex?parseInt(g.zIndex)+1:g.zIndex})}g.touchX=d;g.touchY=c;f.preventDefault();break}}}},touchEnd:function(d){var f=b(this),e=f.data("eraser");if(e.touchDown){var c=d.originalEvent.changedTouches,g=c.length;while(g--){if(c[g].identifier==e.touchID){e.touchDown=false;d.preventDefault();break}}}},evaluatePoint:function(e,d,c){if(!e.enabled){return}var f=Math.floor(d/e.size)+Math.floor(c/e.size)*e.colParts;if(f>=0&&f<e.numParts){e.ratio+=e.parts[f];e.parts[f]=0;if(!e.complete){f=e.ratio/e.numParts;if(f>=e.completeRatio){e.complete=true;if(e.completeFunction!=null){e.completeFunction()}}else{if(e.progressFunction!=null){e.progressFunction(f)}}}}},mouseDown:function(e){var g=b(this),f=g.data("eraser"),d=e.pageX-f.posX,c=e.pageY-f.posY;d*=f.scaleRatio;c*=f.scaleRatio;f.touchDown=true;f.touchX=d;f.touchY=c;if(f.enabled){a.evaluatePoint(f,d,c);f.ctx.beginPath();f.ctx.moveTo(f.touchX-1,f.touchY);f.ctx.lineTo(f.touchX,f.touchY);f.ctx.stroke()}g.bind("mousemove.eraser",a.mouseMove);b(document).bind("mouseup.eraser",f,a.mouseUp);e.preventDefault()},mouseMove:function(e){var g=b(this),f=g.data("eraser"),d=e.pageX-f.posX,c=e.pageY-f.posY;d*=f.scaleRatio;c*=f.scaleRatio;if(f.enabled){a.evaluatePoint(f,d,c);f.ctx.beginPath();f.ctx.moveTo(f.touchX,f.touchY);f.ctx.lineTo(d,c);f.ctx.stroke();g.css({"z-index":g.css("z-index")==f.zIndex?parseInt(f.zIndex)+1:f.zIndex})}f.touchX=d;f.touchY=c;e.preventDefault()},mouseUp:function(c){var d=c.data,e=d.canvas;d.touchDown=false;e.unbind("mousemove.eraser");b(document).unbind("mouseup.eraser");c.preventDefault()},clear:function(){var d=b(this),c=d.data("eraser");if(c){c.ctx.clearRect(0,0,c.w,c.h);var e=c.numParts;while(e--){c.parts[e]=0}c.ratio=c.numParts;c.complete=true;if(c.completeFunction!=null){c.completeFunction()}}},enabled:function(){var d=b(this),c=d.data("eraser");if(c&&c.enabled){return true}return false},enable:function(){var d=b(this),c=d.data("eraser");if(c){c.enabled=true}},disable:function(){var d=b(this),c=d.data("eraser");if(c){c.enabled=false}},size:function(d){var e=b(this),c=e.data("eraser");if(c&&d){c.size=d;c.ctx.lineWidth=d}},reset:function(){var d=b(this),c=d.data("eraser");if(c){c.ctx.globalCompositeOperation="source-over";c.ctx.drawImage(c.source,0,0,c.w,c.h);c.ctx.globalCompositeOperation="destination-out";var e=c.numParts;while(e--){c.parts[e]=1}c.ratio=0;c.complete=false;c.touchDown=false}},progress:function(){var d=b(this),c=d.data("eraser");if(c){return c.ratio/c.numParts}return 0}};b.fn.eraser=function(c){if(a[c]){return a[c].apply(this,Array.prototype.slice.call(arguments,1))}else{if(typeof c==="object"||!c){return a.init.apply(this,arguments)}else{b.error("Method "+c+" does not yet exist on jQuery.eraser")}}}})(jQuery);